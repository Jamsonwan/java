# Mysql

## 第四章 InnoDB的记录结构

### 4.1 简介

* MySQL服务器上负责对表中数据的读取和写入工作部分时存储引擎。真实数据在不同存储引擎中存放的格式一般时不同的。

### 4.2 InnoDB页

* 将数据划分为若干个页，以页作为磁盘和内存之间交互的基本单位，InnoDB中页的大小一般为16KB。也就是说，一次最少从磁盘读取16KB的内容到内存中，一次最少把内存中的16KB内容刷新到磁盘中。

### 4.3 InnoDB行格式

*  平时以记录为单位向表中插入数据，这些记录在磁盘上存放的方式也被称为行格式。

* 4中不同类型的行格式

  * Compact（记录的额外信息和记录的真实数据）

    额外信息：**变长字段长度列、NULL值列、记录头**

    * 把所有变长字段的真实数据占用的字节长度都存放在记录的开头部位，从而形成一个列字段长度列表，各列字段数据占用的字节数按照列的顺序**逆序**存放。
    * 如果该列字段允许存储的最大字节数（表的定义）超过255字节并且真实存储的字节数超过127字节，则使用2个字节，否则使用1个字节。

  * Redundant

  * Dynamic

    * 行溢出：一个页一般时16KB，当记录中的数据太多，当前页放不下的时候，会把多余的数据存储到其他页中，这种现象称为**行溢出**
    * 在行溢出，会指向所有存储该列数据的地址（不会像Redundant会先存储768字节再指向额外的页地址）

  * Compressed

* 一个行中的所有列（不包括隐藏列和记录头信息）占用的字节长度加起来不能超过65535字节。



## 第五章 InnoDB数据页结构

### 5.1 页类型简介

* 索引页、表空间头部信息页、INODE信息页、数据页

### 5.2 数据页

* 数据页代表这块16KB大小的存储空间可以被划分为多个部分
  * File header（38字节） // 页的通用信息
  * Page Header（56字节）// 页的专有信息
  * Infimum + Supremum（26字节） // 虚拟行记录，最小和最大记录
  * User Records （行记录）
  * Free Space
  * File Tailer（8字节）

### 5.3 记录在页中的存储

#### 5.3.1 记录头

* delete_mask: 标记当前记录是否被删除，占用1一个二进制位
* min_rec_mask: 每层非叶子节点中的最小记录都会添加该标记
* n_owned
* heap_no:堆编号位置
* record_type：当前记录的类型
* next_record: 从当前记录的真实数据到下一条记录（按照主键值由小到大的顺序的下一条记录）的真实数据的地址偏移量。
  * Infimum记录（也就是最小记录） 的下一条记录就是 本页中主键值最小的用户记录，而本页中主键值最大的用户记录的下一条记录就是 Supremum记录（也就 是最大记录）

### 5.4 Page Directory(页目录)

#### 5.4.1 页目录制作过程

* 将所有正常的记录（包括最大和最小记录，不包括标记为已删除的记录）划分为几个组。
* 每个组的最后一条记录（也就是组内最大的那条记录）的头信息中的n_owned属性表示该记录拥有多少条记录，也就是改组内共有几条记录。
* 将每个组的最后一条记录的**地址偏移量**单独提取出来按顺序存储到靠近页尾的地方，这个地方就是Page Directory。页面目录中的这些地址偏移量被称为**槽**
* 对于最小记录所在的分组只能有1条记录，最大记录所在的分组拥有的记录条数智能在1-8条之间，剩下的分组中记录的条数范围只能在4-8条之间
* **在数据页中查找指定主键值的记录步骤**
  * 通过二分法确定该记录所在的槽，并找到该槽中主键值最小的那条记录
  * 通过记录头的next_record属性遍历该槽所在的组中的各个记录。



## 第6章 B+树索引

### 6.1 索引

* 下一个数据页中用户记录的主键值必须大于上一个页中用户记录的主键值（页分裂）
* 每个页对应一个目录项(索引)，每个目录项包括：页的用户记录中的最小的主键值，key。还有页号 page_no

### 6.2 索引失效

1. like 以%开头，索引无效，当like前缀没有%,后缀有%时，索引有效
2. or语句前后没有同时使用索引
3. 组合索引，不是使用第一列索引，索引失效
4. 数据类型出现隐式转化。
5. 使用is NULL 或is not null 索引可能失效
6. 索引字段上使用not, <>, != 。 不等于一定失效，key <> 0 可以优化为 key <0 or key > 0
7. 索引字段进行计算操作、字段上使用函数
8. 当全表扫描的速度比索引快时，mysql会使用全表扫描，此时索引失效

